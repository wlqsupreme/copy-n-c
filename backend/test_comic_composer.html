<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¼«ç”»å¯¹è¯æ¡†è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .info-box {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .info-box h4 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .info-box ul {
            margin-left: 20px;
        }

        .info-box li {
            margin: 5px 0;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .storyboard-list {
            margin-top: 20px;
        }

        .storyboard-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .storyboard-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .storyboard-field {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 14px;
        }

        .storyboard-field strong {
            color: #666;
            display: inline-block;
            width: 150px;
        }

        .dialogue-highlight {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin: 10px 0;
        }

        .dialogue-highlight strong {
            color: #856404;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .result h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .image-container {
            margin-top: 20px;
        }

        .image-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-item h4 {
            margin-bottom: 10px;
            color: #667eea;
        }

        .generate-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            padding: 8px 20px;
            font-size: 14px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .pagination button {
            padding: 8px 16px;
            font-size: 14px;
            min-width: 80px;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            margin: 0 15px;
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .pagination .total-info {
            margin-left: 20px;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ æ¼«ç”»å¯¹è¯æ¡†è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•</h1>
            <p>AIç”Ÿæˆçº¯ç”»é¢ + è‡ªåŠ¨æ·»åŠ å¯¹è¯æ¡† = å®Œæ•´æ¼«ç”»åˆ†é•œ</p>
        </div>

        <div class="content">
            <div class="info-box">
                <h4>ğŸ¯ åŠŸèƒ½è¯´æ˜</h4>
                <ul>
                    <li><strong>å›¾æ–‡åˆ†ç¦»ï¼š</strong>AIç”Ÿæˆçº¯è§†è§‰ç”»é¢ï¼ˆä¸å«æ–‡å­—ï¼‰ï¼Œé¿å…ä¸­æ–‡ä¹±ç é—®é¢˜</li>
                    <li><strong>è‡ªåŠ¨å®šä½ï¼š</strong>ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å¯¹è¯å†…å®¹ï¼Œæ™ºèƒ½æ”¾ç½®å¯¹è¯æ¡†ä½ç½®</li>
                    <li><strong>ä¸“ä¸šæ•ˆæœï¼š</strong>ä½¿ç”¨æ¼«ç”»ä¸“ä¸šå¯¹è¯æ¡†æ ·å¼å’Œä¸­æ–‡å­—ä½“</li>
                    <li><strong>ä¸€é”®ç”Ÿæˆï¼š</strong>ä»æ•°æ®åº“è¯»å–åˆ†é•œæ•°æ®ï¼Œè‡ªåŠ¨ç”Ÿæˆå®Œæ•´æ¼«ç”»</li>
                </ul>
            </div>

            <!-- æ‰‹åŠ¨æµ‹è¯•åŒºåŸŸ -->
            <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
                <h4 style="color: #856404;">âœï¸ æ‰‹åŠ¨æµ‹è¯•å¯¹è¯æ¡†åŠŸèƒ½ï¼ˆæ— éœ€æ•°æ®åº“ï¼‰</h4>
                <p style="color: #856404; margin-bottom: 15px;">ç›´æ¥è¾“å…¥ç”»é¢æè¿°å’Œå¯¹è¯å†…å®¹ï¼Œå¿«é€Ÿæµ‹è¯•å¯¹è¯æ¡†æ•ˆæœï¼</p>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                        ğŸ¨ ç”»é¢æè¿°ï¼ˆæç¤ºè¯ï¼‰ï¼š
                    </label>
                    <textarea id="manualPrompt"
                        style="width: 100%; height: 100px; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"
                        placeholder="ä¾‹å¦‚ï¼šä¸€ä¸ªå°‘å¹´ç«™åœ¨å±±é¡¶ï¼ŒèƒŒç€è¡Œå›Šï¼Œå›å¤´æœ›å‘è¿œæ–¹ï¼Œæ¸…æ™¨çš„é›¾æ°”ç¯ç»•ï¼Œæ¼«ç”»é£æ ¼ï¼Œé»‘ç™½çº¿æ¡">æ¼«ç”»é£æ ¼ï¼Œé»‘ç™½çº¿æ¡ã€‚ä¸€ä¸ª17å²çš„å°‘å¹´ï¼Œé»‘è‰²é•¿å‘é©¬å°¾ï¼Œç©¿ç€è“è‰²æ­¦é“è¢ï¼ŒèƒŒç€ç«¹åˆ¶èƒŒåŒ…å’Œå‰‘ã€‚ç«™åœ¨å±±è·¯ä¸Šï¼Œæ¸…æ™¨æµ“é›¾ï¼Œé˜³å…‰æ¼«å°„ã€‚ä¸­æ™¯é•œå¤´ï¼Œä»èƒŒåå‘ˆå››åˆ†ä¹‹ä¸‰è§’åº¦ï¼Œèšç„¦äºè§’è‰²å›æœ›å±±é¡¶ã€‚è¡¨æƒ…æ€€æ—§ï¼Œä¾ä¾ä¸èˆï¼Œæ‰­å¤´å›æœ›ï¼Œé™æ­¢ç«™ç«‹ã€‚</textarea>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                        ğŸ’¬ å¯¹è¯å†…å®¹ï¼ˆå¤šä¸ªå¯¹è¯ç”¨ | åˆ†éš”ï¼‰ï¼š
                    </label>
                    <input id="manualDialogue" type="text"
                        style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"
                        placeholder="ä¾‹å¦‚ï¼šææ…•ç™½ï¼šå¸ˆçˆ¶ï¼Œæˆ‘ä¸€å®šä¼šå­¦æœ‰æ‰€æˆçš„ï¼ | æ—ç™½ï¼šå°‘å¹´è¸ä¸Šäº†æ–°çš„æ—…ç¨‹ã€‚" value="ææ…•ç™½ï¼šå¸ˆçˆ¶ï¼Œæˆ‘ä¸€å®šä¼šå­¦æœ‰æ‰€æˆçš„ï¼" />
                    <small style="color: #856404;">æç¤ºï¼šå¯ä»¥è¾“å…¥å¤šä¸ªå¯¹è¯ï¼Œç”¨ | åˆ†éš”ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å®šä½åˆ°ä¸åŒä½ç½®</small>
                </div>

                <button onclick="generateManualTest()"
                    style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); font-size: 16px; padding: 12px 30px;">
                    ğŸš€ ç«‹å³ç”Ÿæˆæµ‹è¯•ï¼ˆä¸ä¾èµ–æ•°æ®åº“ï¼‰
                </button>
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 2px solid #eee;">

            <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“š æˆ–ä»æ•°æ®åº“è¯»å–åˆ†é•œ</h3>
            <button onclick="loadStoryboards()">ğŸ“š åŠ è½½æ•°æ®åº“åˆ†é•œåˆ—è¡¨ï¼ˆç¬¬1é¡µï¼‰</button>
            <button onclick="testConnection()">ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥</button>

            <!-- åˆ†é¡µæ§åˆ¶ -->
            <div id="pagination" class="pagination" style="display: none;">
                <button onclick="loadPreviousPage()" id="prevBtn">â¬…ï¸ ä¸Šä¸€é¡µ</button>
                <span class="page-info">
                    ç¬¬ <span id="currentPage">1</span> é¡µ
                </span>
                <button onclick="loadNextPage()" id="nextBtn">ä¸‹ä¸€é¡µ â¡ï¸</button>
                <span class="total-info">
                    ï¼ˆå…± <span id="totalCount">0</span> æ¡æ•°æ®ï¼Œæ¯é¡µ10æ¡ï¼‰
                </span>
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>ç”Ÿæˆä¸­...</p>
            </div>

            <div id="storyboardList" class="storyboard-list"></div>
            <div id="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1/storyboard-gen';
        const TEXT_TO_IMAGE_API = 'http://localhost:8000/api/v1/text-to-image';

        // åˆ†é¡µçŠ¶æ€
        let currentPage = 1;
        let pageSize = 10;
        let totalCount = 0;

        // æ‰‹åŠ¨æµ‹è¯•å¯¹è¯æ¡†åŠŸèƒ½
        async function generateManualTest() {
            const prompt = document.getElementById('manualPrompt').value.trim();
            const dialogueInput = document.getElementById('manualDialogue').value.trim();

            if (!prompt) {
                showMessage('error', 'è¯·è¾“å…¥ç”»é¢æè¿°ï¼');
                return;
            }

            if (!dialogueInput) {
                showMessage('error', 'è¯·è¾“å…¥å¯¹è¯å†…å®¹ï¼');
                return;
            }

            showLoading();
            document.getElementById('loading').innerHTML = `
                <div class="spinner"></div>
                <p>ç¬¬1æ­¥ï¼šAIç”Ÿæˆçº¯ç”»é¢ï¼ˆä¸å«æ–‡å­—ï¼‰...</p>
                <p>ç¬¬2æ­¥ï¼šè‡ªåŠ¨æ·»åŠ å¯¹è¯æ¡†...</p>
                <p>è¯·ç¨å€™ï¼ˆçº¦10-30ç§’ï¼‰...</p>
            `;

            try {
                // ç¬¬1æ­¥ï¼šç”Ÿæˆçº¯ç”»é¢
                console.log('ğŸ¨ å¼€å§‹ç”Ÿæˆçº¯ç”»é¢...');
                const imageResponse = await fetch(`${TEXT_TO_IMAGE_API}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        size: '1024x1024',
                        quality: 'standard',
                        style: 'vivid'
                    })
                });

                if (!imageResponse.ok) {
                    throw new Error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
                }

                const imageData = await imageResponse.json();
                console.log('âœ… çº¯ç”»é¢ç”ŸæˆæˆåŠŸ');

                // ç¬¬2æ­¥ï¼šæ·»åŠ å¯¹è¯æ¡†
                console.log('ğŸ¨ å¼€å§‹æ·»åŠ å¯¹è¯æ¡†...');

                // è§£æå¯¹è¯å†…å®¹ï¼ˆæ”¯æŒ | åˆ†éš”å¤šä¸ªå¯¹è¯ï¼‰
                const dialogues = dialogueInput.split('|').map(d => ({
                    text: d.trim(),
                    bubble_type: 'speech'
                }));

                // è°ƒç”¨åç«¯å¯¹è¯æ¡†åˆæˆAPI
                const composeResponse = await fetch('http://localhost:8000/api/v1/dialogue/compose', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_base64: imageData.image.url,
                        dialogues: dialogues,
                        camera_angle: null
                    })
                });

                let finalImageUrl = imageData.image.url;
                let hasDialogue = false;

                if (composeResponse.ok) {
                    const composeData = await composeResponse.json();
                    finalImageUrl = composeData.image;
                    hasDialogue = true;
                    console.log('âœ… å¯¹è¯æ¡†æ·»åŠ æˆåŠŸ');
                } else {
                    console.warn('âš ï¸ å¯¹è¯æ¡†æ·»åŠ å¤±è´¥ï¼Œæ˜¾ç¤ºåŸå›¾');
                }

                // æ˜¾ç¤ºç»“æœ
                displayManualTestResult({
                    prompt: prompt,
                    dialogues: dialogues,
                    imageUrl: finalImageUrl,
                    originalImageUrl: imageData.image.url,
                    hasDialogue: hasDialogue
                });

                console.log('âœ… æµ‹è¯•å®Œæˆ');

            } catch (error) {
                console.error('âŒ ç”Ÿæˆå¤±è´¥:', error);
                showMessage('error', `ç”Ÿæˆå¤±è´¥: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function displayManualTestResult(data) {
            const resultDiv = document.getElementById('result');

            const dialogueList = data.dialogues.map((d, i) =>
                `<li>å¯¹è¯ #${i + 1}: ${d.text}</li>`
            ).join('');

            resultDiv.innerHTML = `
                <div class="result">
                    <h3>âœ… æµ‹è¯•ç”ŸæˆæˆåŠŸï¼</h3>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #1976d2;">ğŸ“ ä½¿ç”¨çš„æç¤ºè¯ï¼š</h4>
                        <p style="color: #1976d2; font-size: 14px; margin-top: 10px;">${data.prompt}</p>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #856404;">ğŸ’¬ å¯¹è¯å†…å®¹ï¼š</h4>
                        <ul style="color: #856404; margin-left: 20px; margin-top: 10px;">
                            ${dialogueList}
                        </ul>
                    </div>

                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #2e7d32;">ğŸ¯ ç”Ÿæˆæµç¨‹ï¼š</h4>
                        <p style="color: #2e7d32; margin-top: 10px;">
                            âœ… ç¬¬1æ­¥ï¼šAIå·²ç”Ÿæˆçº¯ç”»é¢ï¼ˆæ— æ–‡å­—ï¼‰<br>
                            ${data.hasDialogue ? 'âœ… ç¬¬2æ­¥ï¼šå¯¹è¯æ¡†å·²è‡ªåŠ¨æ·»åŠ ï¼' : 'âš ï¸ ç¬¬2æ­¥ï¼šå¯¹è¯æ¡†æ·»åŠ å¤±è´¥ï¼ˆæ£€æŸ¥åç«¯æœåŠ¡ï¼‰'}<br>
                            ğŸ’¡ ${data.hasDialogue ? 'å›¾æ–‡åˆ†ç¦»å®Œæˆï¼Œæ–‡å­—æ¸…æ™°æ— ä¹±ç ï¼' : 'è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ'}
                        </p>
                    </div>
                    
                    <div class="image-container">
                        <h4>ğŸ“¸ ${data.hasDialogue ? 'æœ€ç»ˆæ•ˆæœï¼ˆå«å¯¹è¯æ¡†ï¼‰' : 'ç”Ÿæˆçš„çº¯ç”»é¢'}ï¼š</h4>
                        <img src="${data.imageUrl}" alt="${data.hasDialogue ? 'å®Œæ•´æ¼«ç”»' : 'çº¯ç”»é¢'}" />
                        <p style="text-align:center; ${data.hasDialogue ? 'color:#4CAF50; font-weight:bold;' : 'color:#666;'} margin-top:10px;">
                            ${data.hasDialogue ? 'âœ¨ å¯¹è¯æ¡†å·²è‡ªåŠ¨æ·»åŠ ï¼æ–‡å­—æ¸…æ™°ï¼Œæ— ä¹±ç ï¼' : 'çº¯ç”»é¢ï¼Œæœªæ·»åŠ å¯¹è¯æ¡†'}
                        </p>
                    </div>

                    ${!data.hasDialogue ? `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #856404;">ğŸ” troubleshootingï¼š</h4>
                        <ol style="color: #856404; margin-left: 20px; margin-top: 10px;">
                            <li>æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li>
                            <li>æ£€æŸ¥æ˜¯å¦å·²å®‰è£… Pillow åº“: pip install Pillow==10.3.0</li>
                            <li>æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°å’Œåç«¯æ—¥å¿—æŸ¥æ‰¾é”™è¯¯</li>
                        </ol>
                    </div>
                    ` : `
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #2e7d32;">âœ… æµ‹è¯•æˆåŠŸï¼</h4>
                        <p style="color: #2e7d32; margin-top: 10px;">
                            å¯¹è¯æ¡†åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼ä½ å¯ä»¥ï¼š<br>
                            1. å°è¯•è¾“å…¥ä¸åŒçš„å¯¹è¯å†…å®¹ï¼ˆæ”¯æŒ | åˆ†éš”å¤šä¸ªå¯¹è¯ï¼‰<br>
                            2. åœ¨æ•°æ®åº“ä¸­æ·»åŠ  dialogue å­—æ®µåä½¿ç”¨å®Œæ•´åŠŸèƒ½<br>
                            3. é›†æˆåˆ°Vueå‰ç«¯é¡¹ç›®ä¸­
                        </p>
                    </div>
                    `}
                </div>
            `;

            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function testConnection() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                if (data.ok) {
                    showMessage('success', `
                        âœ… è¿æ¥æˆåŠŸ<br>
                        æ•°æ®åº“çŠ¶æ€: ${data.database_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}<br>
                        æœåŠ¡: ${data.service}
                    `);
                } else {
                    showMessage('error', 'è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                showMessage('error', `è¿æ¥é”™è¯¯: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        async function loadStoryboards(page = 1) {
            showLoading();
            document.getElementById('storyboardList').innerHTML = '';
            document.getElementById('result').innerHTML = '';

            currentPage = page;
            const offset = (page - 1) * pageSize;

            try {
                // ä¿®æ”¹ï¼šä½¿ç”¨åˆ†é¡µå‚æ•° limit å’Œ offset
                const response = await fetch(`${API_BASE}/list-storyboards?limit=${pageSize}&offset=${offset}`);
                const data = await response.json();

                if (response.ok && data.ok) {
                    totalCount = data.count; // ä¿å­˜æ€»æ•°
                    displayStoryboards(data.storyboards);
                    updatePagination();
                    showMessage('success', `âœ… æˆåŠŸåŠ è½½ç¬¬ ${page} é¡µï¼ˆå…± ${data.count} æ¡æ•°æ®ï¼‰`);
                } else {
                    showMessage('error', data.detail || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                showMessage('error', `åŠ è½½é”™è¯¯: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½ä¸Šä¸€é¡µ
        function loadPreviousPage() {
            if (currentPage > 1) {
                loadStoryboards(currentPage - 1);
            }
        }

        // åŠ è½½ä¸‹ä¸€é¡µ
        function loadNextPage() {
            const totalPages = Math.ceil(totalCount / pageSize);
            if (currentPage < totalPages) {
                loadStoryboards(currentPage + 1);
            }
        }

        // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
        function updatePagination() {
            const paginationDiv = document.getElementById('pagination');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const currentPageSpan = document.getElementById('currentPage');
            const totalCountSpan = document.getElementById('totalCount');

            // æ˜¾ç¤ºåˆ†é¡µæ§ä»¶
            paginationDiv.style.display = 'flex';

            // æ›´æ–°é¡µç æ˜¾ç¤º
            currentPageSpan.textContent = currentPage;
            totalCountSpan.textContent = totalCount;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const totalPages = Math.ceil(totalCount / pageSize);
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages || totalCount === 0;
        }

        function displayStoryboards(storyboards) {
            const listDiv = document.getElementById('storyboardList');

            if (storyboards.length === 0) {
                listDiv.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">å½“å‰é¡µæ²¡æœ‰æ•°æ®</p>';
                return;
            }

            const startIndex = (currentPage - 1) * pageSize;
            let html = `<h3 style="margin-bottom:15px;">æ•°æ®åº“åˆ†é•œåˆ—è¡¨ - ç¬¬ ${currentPage} é¡µï¼ˆåŒ…å«å¯¹è¯å†…å®¹ï¼‰</h3>`;

            storyboards.forEach((item, index) => {
                const globalIndex = startIndex + index + 1; // å…¨å±€ç´¢å¼•

                // æ£€æŸ¥ panel_elements å­—æ®µä¸­æ˜¯å¦æœ‰å¯¹è¯
                let hasDialogue = false;
                let dialoguePreview = "æ— ";

                try {
                    if (item.panel_elements) {
                        const panelElements = typeof item.panel_elements === 'string'
                            ? JSON.parse(item.panel_elements)
                            : item.panel_elements;

                        if (Array.isArray(panelElements) && panelElements.length > 0) {
                            const dialogueItems = panelElements.filter(el => el.dialogue && el.dialogue.trim());
                            if (dialogueItems.length > 0) {
                                hasDialogue = true;
                                dialoguePreview = dialogueItems.map(el =>
                                    `${el.characterid ? '[è§’è‰²ID:' + el.characterid + '] ' : ''}${el.dialogue}`
                                ).join(' | ');
                            }
                        }
                    }
                } catch (e) {
                    console.error('è§£æ panel_elements å¤±è´¥:', e);
                }

                html += `
                    <div class="storyboard-item">
                        <h4>åˆ†é•œ #${globalIndex} ${item.storyboard_id ? `(ID: ${item.storyboard_id.substring(0, 8)}...)` : ''}</h4>
                        <div class="storyboard-field">
                            <strong>åŸæ–‡ç‰‡æ®µ:</strong> ${truncate(item.original_text_snippet || '-', 50)}
                        </div>
                        <div class="storyboard-field">
                            <strong>è§’è‰²å¤–è§‚:</strong> ${item.character_appearance || '-'}
                        </div>
                        <div class="storyboard-field">
                            <strong>åœºæ™¯å…‰çº¿:</strong> ${item.scene_and_lighting || '-'}
                        </div>
                        <div class="storyboard-field">
                            <strong>é•œå¤´æ„å›¾:</strong> ${item.camera_and_composition || '-'}
                        </div>
                        <div class="storyboard-field">
                            <strong>è¡¨æƒ…åŠ¨ä½œ:</strong> ${item.expression_and_action || '-'}
                        </div>
                        <div class="storyboard-field">
                            <strong>é£æ ¼è¦æ±‚:</strong> ${item.style_requirements || '-'}
                        </div>
                        ${hasDialogue ? `
                            <div class="dialogue-highlight">
                                <strong>ğŸ’¬ å¯¹è¯å†…å®¹ (panel_elements):</strong><br>
                                <span style="font-size: 14px;">${dialoguePreview}</span>
                                <br><small style="color:#856404;">âš¡ å°†è‡ªåŠ¨å…³è” characters è¡¨å¹¶æ·»åŠ å¯¹è¯æ¡†ï¼</small>
                            </div>
                        ` : '<div class="storyboard-field"><strong>å¯¹è¯:</strong> æ—  (panel_elements ä¸ºç©º)</div>'}
                        <button class="generate-btn" onclick="generateImage('${item.storyboard_id}')">
                            ğŸ¨ ç”Ÿæˆå®Œæ•´æ¼«ç”»${hasDialogue ? 'ï¼ˆå«å¯¹è¯æ¡†ï¼‰' : ''}
                        </button>
                    </div>
                `;
            });

            listDiv.innerHTML = html;
        }

        async function generateImage(storyboardId) {
            showLoading();
            document.getElementById('loading').innerHTML = `
                <div class="spinner"></div>
                <p>æ­£åœ¨ä»æ•°æ®åº“è¯»å–æ•°æ®...</p>
                <p>æ­£åœ¨ç”Ÿæˆçº¯ç”»é¢...</p>
                <p>æ­£åœ¨æ·»åŠ å¯¹è¯æ¡†...</p>
                <p>è¯·ç¨å€™ï¼ˆçº¦10-30ç§’ï¼‰...</p>
            `;

            try {
                const response = await fetch(`${API_BASE}/generate-from-db/${storyboardId}?size=1024x1024`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok && data.ok) {
                    displayResult(data);
                } else {
                    showMessage('error', data.detail || 'ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                showMessage('error', `ç”Ÿæˆé”™è¯¯: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function displayResult(data) {
            const resultDiv = document.getElementById('result');

            const hasDialogue = data.has_dialogue;

            resultDiv.innerHTML = `
                <div class="result">
                    <h3>âœ… ${data.message}</h3>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4 style="color: #856404; margin-bottom: 10px;">ğŸ¨ ç”Ÿæˆæµç¨‹ï¼š</h4>
                        <ol style="color: #856404; margin-left: 20px;">
                            <li>AIç”Ÿæˆçº¯ç”»é¢ï¼ˆä¸å«æ–‡å­—ï¼‰âœ…</li>
                            <li>${hasDialogue ? 'è‡ªåŠ¨æ·»åŠ å¯¹è¯æ¡† âœ…' : 'æ— å¯¹è¯å†…å®¹ï¼Œè·³è¿‡ âšª'}</li>
                            <li>è¿”å›å®Œæ•´æ¼«ç”» âœ…</li>
                        </ol>
                    </div>
                    
                    ${hasDialogue ? `
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="color: #2e7d32;">ğŸ’¬ å¯¹è¯å†…å®¹ï¼ˆ${data.dialogue_count} æ¡ï¼‰ï¼š</h4>
                            <div style="margin-top: 10px;">
                                ${data.dialogues ? data.dialogues.map((d, idx) => `
                                    <div style="background: white; padding: 10px; border-radius: 5px; margin: 8px 0; border-left: 4px solid #4CAF50;">
                                        <strong style="color: #2e7d32;">${d.speaker || 'æ—ç™½'}ï¼š</strong>
                                        <span style="color: #333;">${d.text}</span>
                                    </div>
                                `).join('') : '<p style="color: #2e7d32;">æ— å¯¹è¯æ•°æ®</p>'}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="image-container">
                        <h4>ğŸ“¸ æœ€ç»ˆæ•ˆæœï¼š</h4>
                        <img src="${data.image.url}" alt="ç”Ÿæˆçš„å®Œæ•´æ¼«ç”»åˆ†é•œ" />
                        ${hasDialogue ? '<p style="text-align:center; color:#4CAF50; margin-top:10px; font-weight:bold;">âœ¨ å¯¹è¯æ¡†å·²è‡ªåŠ¨æ·»åŠ ï¼æ–‡å­—æ¸…æ™°æ— ä¹±ç ï¼</p>' : ''}
                    </div>
                </div>
            `;

            // æ»šåŠ¨åˆ°ç»“æœ
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function showMessage(type, message) {
            const resultDiv = document.getElementById('result');
            const color = type === 'success' ? '#4CAF50' : '#f44336';
            resultDiv.innerHTML = `
                <div class="result" style="border-left-color: ${color};">
                    <h3 style="color: ${color};">${type === 'success' ? 'âœ…' : 'âŒ'} ${type === 'success' ? 'æˆåŠŸ' : 'é”™è¯¯'}</h3>
                    <p>${message}</p>
                </div>
            `;
        }

        function truncate(str, length) {
            if (!str) return '-';
            return str.length > length ? str.substring(0, length) + '...' : str;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            testConnection();
        });
    </script>
</body>

</html>